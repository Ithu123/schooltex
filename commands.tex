% This is for common commands 




\input{scriptcommands.tex}% Commands for scripts 
\input{sheetcommands.tex} % Commands for exercise-sheets 


% Common Commands 

% \newcommand{\mitte}{ \hfill\vrule\hfill\hspace{0.1em} }%FÃœr die Mitte zwischen zwei Minipages

% A 0.5cm grid at given thingy
% Define a command for rounding down to the nearest lower multiple of 0.5


\newlength{\remainingheight} % Define a length variable to store the remaining height

\newcommand{\rounddowncm}[2][\ergeb]{%
  \pgfmathtruncatemacro{#1}{int(floor(#2*2*0.0352778))/2}%
}

\newcommand{\grid}[1][0]{% Default height is set to 0
  \par
  \vspace{\baselineskip}
  \noindent
  % Calculate the remaining height if no height is provided
  \ifnum#1=0
    \setlength{\remainingheight}{\dimexpr\textheight-\pagetotal-\baselineskip}
  \else
    \setlength{\remainingheight}{#1}
  \fi
  \begin{tikzpicture}
    \rounddowncm{\textwidth}
    \edef\myresult{\ergeb} % Expanding the \ergeb variable
    \draw[step=0.5cm, color=gray] (0,0) grid (\myresult + 0.5, \remainingheight);
    % You can use the \myresult and \remainingheight values for further calculations or display
    %\node[anchor=south] at (\myresult + 0.75, \remainingheight) {\textbf{Width: \myresult cm}};
  \end{tikzpicture}%
  \par
}




% New image command

\makeatletter
\newcounter{imagesourcecounter}
\setcounter{imagesourcecounter}{1}

\providecommand{\imagecaption}{}
\define@key{image}{width}{\def\image@width{#1}}
\define@key{image}{caption}{\def\image@caption{#1}}
\define@key{image}{source}{\def\image@source{#1}}
\define@key{image}{position}{\def\image@position{#1}}
\define@key{image}{overhang}{\def\image@overhang{#1}}
\define@key{image}{line}{\def\image@line{#1}}
\define@key{image}{label}{\def\image@label{#1}}
\setkeys{image}{width=5cm, caption=, source=, position=, overhang=, line =, label =   }

% Define a command to conditionally include the optional argument for wrapfigure
\NewDocumentCommand{\wrapfigureopt}{m m O{} m}{%
  \ifdefempty{#1}{%
    \begin{wrapfigure}{#2}{#3}
      #4
    \end{wrapfigure}%
  }{%
    \begin{wrapfigure}[#1]{#2}[#3]{#3}
      #4
    \end{wrapfigure}%
  }%
}

% Provide a function that handles the caption
\newcommand{\handleImageCaption}[2]{
  \ifdefempty{#1}{
    \renewcommand{\imagecaption}{\protect\caption{#2}}
    \ifdefempty{#2}{
      \renewcommand{\imagecaption}{}
    }{}
  }{
    \ifdefempty{#2}{
      %\PackageError{schooltex}{No Caption provided}{Please provide a caption which the source can be added to.}
      \renewcommand{\imagecaption}{\protect\caption{#2\protect\footnotemark}}
      \footnotetext[\theimagesourcecounter]{Quelle: \protect#1}
      \stepcounter{imagesourcecounter}
    }{
      \renewcommand{\imagecaption}{\protect\caption{#2\protect\footnotemark}}
      \footnotetext[\theimagesourcecounter]{Quelle: \protect#1}
      \stepcounter{imagesourcecounter}
    }
  }
}
\newcommand{\mylabel}{}
\newcommand{\handlelabel}[1]{
  \ifdefempty{#1}{
    \renewcommand{\mylabel}{}
  }{
    \renewcommand{\mylabel}{\protect\label{#1}}
  }
  


}

\providecommand{\image}[2][]{%
\setkeys{image}{width=5cm, caption=, source=, position=, overhang=0.5 cm, line =  }
  \setkeys{image}{#1}% Set the keys
  \handleImageCaption{\image@source}{\image@caption}
  \handlelabel{\image@label}
  \ifdefempty{\image@position}{
    % No position specified, use figure
    \begin{figure}[!ht]
      \centering
      \includegraphics[width=\image@width]{#2}
      \imagecaption
      \mylabel
    \end{figure}
  }{
    % Position specified, use wrapfigure
    \wrapfigureopt{\image@line}{\image@position}[\dimexpr\image@width+2\columnsep]{%
      \centering
      \includegraphics[width=\dimexpr\linewidth-2\columnsep]{#2}
      \begin{minipage}{\dimexpr\linewidth-2\columnsep} % Ensure caption width doesn't exceed image width
        \imagecaption
        \mylabel
      \end{minipage}
    }%
  }%
}
\makeatother





% Define a new command \multiimage with optional arguments
\newlength{\subfigurewidth}
\makeatletter
\define@key{multiimage}{caption}{\def\multiimage@caption{#1}} % Define a key for the caption
\define@key{multiimage}{label}{\def\multiimage@label{#1}} % Define a key for the label
\define@key{multiimage}{rescale}{\def\rescale{#1}} % Define a key for the rescale each image
\define@key{multiimage}{source}{\def\multiimage@source{#1}}

\providecommand{\multiimage}[2][]{ % Optional arguments are provided as a key-value list
  \setkeys{multiimage}{caption=, label=, rescale = 1.0, source = , #1} % Set default values and apply user-provided values
  \handleImageCaption{\multiimage@source}{\multiimage@caption}
  \handlelabel{\multiimage@label}
  \readlist\figruelist{#2} % Read and store the elements of the list
  
  % Calculate the width of each subfigure based on the number of elements and rescale factor
  
  \setlength{\subfigurewidth}{0.8\dimexpr(\rescale\linewidth/\figruelistlen)\relax}
  


  \begin{figure}[h!]
    \centering
    \foreachitem\i\in\figruelist{
      \begin{subfigure}{\subfigurewidth} % Adjust the width dynamically
        \centering
        \includegraphics[width=\linewidth]{\i}
        \caption{} 
      \end{subfigure}%
    }

    \imagecaption 
    \mylabel % Use the provided label or the default label for the figure label
  \end{figure}
}

\makeatother