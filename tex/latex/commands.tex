% This is for common commands 




\input{scriptcommands.tex}% Commands for scripts 
\input{sheetcommands.tex} % Commands for exercise-sheets 


% Common Commands 


% A 0.5cm grid at given text
\newcommand{\getpagetotal}{\the\pagetotal}
\newcommand{\gettextheight}{\the\textheight}
\newcommand{\getbaselineskip}{\the\baselineskip}
%grid command
\ProvideDocumentCommand{\grid}{O{0}}{
\vspace{\baselineskip}

\pgfmathsetmacro{\theight}{scalar(\gettextheight)}
\pgfmathsetmacro{\pat}{scalar(\getpagetotal)}
\pgfmathsetmacro{\bsskip}{scalar(\getbaselineskip)}

\dimendef\gridwidth=0
\pgfmathsetlength{\gridwidth}{1 cm * floor(scalar(\textwidth)*0.0352778) }

\ifnum#1=0
  \pgfmathsetmacro{\gridheight}{1 cm * floor((\theight-\pat-\bsskip)*0.0352778) }
\else
  \pgfmathsetmacro{\gridheight}{1 cm *#1 }
\fi

{\centering
\begin{tikzpicture}
  \tikz 
  \coordinate (A) at (canvas cs:x=\gridwidth,y=\gridheight) {};
  \draw[step=0.5cm, color=gray] (0cm ,0 cm ) grid (canvas cs:x=\gridwidth,y=\gridheight);
\end{tikzpicture}
}%

}



% New image command
\makeatletter
\newcounter{imagesourcecounter}
\setcounter{imagesourcecounter}{1}

\providecommand{\imagecaption}{}
\define@key{image}{width}{\def\image@width{#1}}
\define@key{image}{caption}{\def\image@caption{#1}}
\define@key{image}{source}{\def\image@source{#1}}
\define@key{image}{position}{\def\image@position{#1}}
\define@key{image}{overhang}{\def\image@overhang{#1}}
\define@key{image}{line}{\def\image@line{#1}}
\define@key{image}{label}{\def\image@label{#1}}
\setkeys{image}{width=5cm, caption=, source=, position=, overhang=, line =, label =   }

% Define a command to conditionally include the optional argument for wrapfigure
\NewDocumentCommand{\wrapfigureopt}{m m O{} m}{%
  \ifdefempty{#1}{%
    \begin{wrapfigure}{#2}{#3}
      #4
    \end{wrapfigure}%
  }{%
    \begin{wrapfigure}[#1]{#2}[#3]{#3}
      #4
    \end{wrapfigure}%
  }%
}

% Provide a function that handles the caption
\newcommand{\handleImageCaption}[2]{
  \ifdefempty{#1}{
    \renewcommand{\imagecaption}{\protect\caption{#2}}
    \ifdefempty{#2}{
      \renewcommand{\imagecaption}{}
    }{}
  }{
    \ifdefempty{#2}{
      %\PackageError{schooltex}{No Caption provided}{Please provide a caption which the source can be added to.}
      \renewcommand{\imagecaption}{\protect\caption{#2\protect\footnotemark}}
      \footnotetext[\theimagesourcecounter]{Quelle: \protect#1}
      \stepcounter{imagesourcecounter}
    }{
      \renewcommand{\imagecaption}{\protect\caption{#2\protect\footnotemark}}
      \footnotetext[\theimagesourcecounter]{Quelle: \protect#1}
      \stepcounter{imagesourcecounter}
    }
  }
}
\newcommand{\mylabel}{}
\newcommand{\handlelabel}[1]{
  \ifdefempty{#1}{
    \renewcommand{\mylabel}{}
  }{
    \renewcommand{\mylabel}{\protect\label{#1}}
  }
}



% \handlesubcaption{number of images}{list of captions}{}

\ProvideDocumentCommand{\image}{O{} m}{
\setkeys{image}{width=5cm, caption=, source=, position=, overhang=0.5 cm, line =  }
  \setkeys{image}{#1}% Set the keys
  \handleImageCaption{\image@source}{\image@caption}
  \handlelabel{\image@label}
  \ifdefempty{\image@position}{
    % No position specified, use figure
    \begin{figure}[!ht]
      \centering
      \includegraphics[width=\image@width]{#2}
      \imagecaption
      \mylabel
    \end{figure}
  }{
    % Position specified, use wrapfigure
    \wrapfigureopt{\image@line}{\image@position}[\dimexpr\image@width+2\columnsep]{%
      \centering
      \includegraphics[width=\dimexpr\linewidth-2\columnsep]{#2}
      \begin{minipage}{\dimexpr\linewidth-2\columnsep} % Ensure caption width doesn't exceed image width
        \imagecaption
        \mylabel
      \end{minipage}
    }%
  }%
}
\makeatother




\makeatletter
\newcounter{captioncounter}
\setcounter{captioncounter}{1}
\providecommand{\handlesubcaptions}[1]{%
    \readlist\captionlist{#1}
}
\makeatother

% Define a new command \multiimage with optional arguments
\newlength{\subfigurewidth}
\makeatletter
\define@key{multiimage}{caption}{\def\multiimage@caption{#1}} % Define a key for the caption
\define@key{multiimage}{subcaptions}{\def\multiimage@subcaptions{#1}} % Define a key for the caption
\define@key{multiimage}{label}{\def\multiimage@label{#1}} % Define a key for the label
\define@key{multiimage}{rescale}{\def\rescale{#1}} % Define a key for the rescale each image
\define@key{multiimage}{source}{\def\multiimage@source{#1}}
\define@key{multiimage}{widtheach}{\def\multiimage@widtheach{#1}}



\ProvideDocumentCommand{\multiimage}{O{} m}{ % Optional arguments are provided as a key-value list
  \setkeys{multiimage}{caption=, label=, rescale = 1.0, source = ,widtheach = ,subcaptions = , #1} % Set default values and apply user-provided values
  
  %Look for captions
  \handleImageCaption{\multiimage@source}{\multiimage@caption}
  \handlelabel{\multiimage@label}
  \readlist\figruelist{#2} % Read and store the elements of the list


  % Look for subcaptions
  \ifdefempty{\multiimage@subcaptions}{ 
    \relax
  }{  
    \readlist\captionlist{\multiimage@subcaptions}
    }
  % Calculate the width of each subfigure based on the number of elements and rescale factor
\ifdefempty{\multiimage@widtheach}{
  \setlength{\subfigurewidth}{0.8\dimexpr(\rescale\linewidth/\figruelistlen)\relax}
  }{
  \setlength{\subfigurewidth}{\multiimage@widtheach}
  }

  \begin{figure}[h!]
    \centering
    \foreachitem\i\in\figruelist{
      \begin{subfigure}{\subfigurewidth} % Adjust the width dynamically
        \centering
        \includegraphics[width=\linewidth]{\i}
        \ifdefempty{\multiimage@subcaptions}{
          \ifx{\multiimage@subcaptions}{nosubcaptions} % Options subcaptions =nosubcaptions
          \relax 
          \else
          \caption{ } %Standard
          \fi
        }{  
          \expandafter\caption{\captionlist[\icnt]} %if there are subcaptions
          }
        \stepcounter{captioncounter}
      \end{subfigure}%
    }
    \setcounter{captioncounter}{1}
    \imagecaption 
    \mylabel % Use the provided label or the default label for the figure label
  \end{figure}
}
\makeatother


